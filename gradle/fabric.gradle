def getFabricApiKey = { ->
    def noKey = "abcdeabcde123456789012345678901234567890"
    def key = null
    if (System.getenv("CI") == "true") {
        key = System.getenv("FABRIC_API_KEY") ?: noKey
        if (key == noKey)
            println "Fabric Api key not found in variables. Please set it in CI secret env vars" + key
        return key
    } else {
        key = loadFromPropertyFile() ?: noKey
        if (key == noKey)
            println "Make sure correct Fabric Api key is set in fabric.properties"
    }
    return key
}

def loadFromPropertyFile() {
    def props = new Properties()
    try {
        props.load(new FileReader('app/fabric.properties'))
        def key = props.getProperty('apiKey')
        return key
    } catch (IOException ignored) {
        println "Fabric Api key not found in properties file"
        return null
    }
}

task fabricProperties() {
    description "Generate fabric.properties file"
    ant.propertyfile(file: "$projectDir/fabric.properties") {
        entry(key: "apiKey", default: getFabricApiKey())
    }
}

preBuild.dependsOn('fabricProperties')